image: php:8.2

stages:
  - test
  - deploy

# ğŸ§ª Tests - S'exÃ©cute sur toutes les branches
test:
  stage: test
  tags:
    - back
  before_script:
    # Installation des dÃ©pendances systÃ¨me
    - apt-get update -qq && apt-get install -y -qq git curl libzip-dev unzip
    - docker-php-ext-install zip pdo_mysql
    
    # Installation de Composer
    - curl -sS https://getcomposer.org/installer | php
    - mv composer.phar /usr/local/bin/composer
    
    # Installation des dÃ©pendances PHP
    - composer install --prefer-dist --no-interaction
    
    # Configuration de l'environnement de test
    - cp .env.testing .env
    - php artisan key:generate --force
    
  script:
    - echo "ğŸ§ª Lancement des tests..."
    - php artisan test
    - echo "âœ… Tests terminÃ©s"
    
  artifacts:
    when: always
    reports:
      junit: storage/logs/junit.xml
    paths:
      - storage/logs/
    expire_in: 1 week

# ğŸš€ DÃ©ploiement - Seulement sur main et aprÃ¨s succÃ¨s des tests
deploy:
  stage: deploy
  tags:
    - back
  dependencies:
    - test
  script:
    - echo "ğŸšš DÃ©ploiement du back..."
    - sudo rm -rf /home/flowadmin/back/*
    - sudo cp -r . /home/flowadmin/back/
    - echo "ğŸ”ƒ RedÃ©marrage de Nginx et PHP..."
    - sudo docker compose -f /home/flowadmin/docker-compose.yml restart nginx
    - echo "âœ… DÃ©ploiement terminÃ©"
  only:
    - main
  needs:
    - test

