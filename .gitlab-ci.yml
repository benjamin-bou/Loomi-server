image: php:8.2

stages:
  - test
  - deploy

test:
  stage: test
  tags:
    - back
  script:
    # VÃ©rifier la version de PHP et les extensions indispensables
    - php --version
    - php -m | grep -E "(dom|xml|zip|mbstring)" || (echo "âŒ Extensions PHP manquantes !" && exit 1)
    - composer --version || (curl -sS https://getcomposer.org/installer | php && mv composer.phar /usr/local/bin/composer)
    - composer install --prefer-dist --no-interaction --no-scripts
    - cp .env.testing .env
    - php artisan key:generate --force
    - php artisan migrate --env=testing --force
    - mkdir -p storage/logs
    - php artisan test --log-junit storage/logs/junit.xml --stop-on-failure > test_output.txt 2>&1
    - TEST_EXIT_CODE=$?
    - echo "ğŸ“‹ RÃ©sultats des tests:"
    - cat test_output.txt
    - if grep -q "Tests:" test_output.txt && ! grep -q "FAILED" test_output.txt && ! grep -q "ERRORS" test_output.txt; then echo "âœ… Tous les tests sont passÃ©s" && exit 0; else echo "âŒ Tests Ã©chouÃ©s" && exit 1; fi
    - test -f storage/logs/junit.xml && echo "ğŸ“„ Rapport JUnit gÃ©nÃ©rÃ©" || echo "âš ï¸ Pas de rapport JUnit"
  artifacts:
    when: always
    reports:
      junit: storage/logs/junit.xml
    paths:
      - storage/logs/
    expire_in: 1 week

deploy:
  stage: deploy
  script:
    - echo "ğŸš€ DÃ©ploiement du back..."
    - rm -rf /home/flowadmin/back/*
    - cp -r . /home/flowadmin/back/
    - echo "ğŸ”ƒ RedÃ©marrage de Nginx et PHP..."
    - docker compose -f /home/flowadmin/docker-compose.yml restart nginx
    - echo "âœ… DÃ©ploiement terminÃ©"
  only:
    - main
  dependencies:
    - test
  needs:
    - test
  tags:
    - back
