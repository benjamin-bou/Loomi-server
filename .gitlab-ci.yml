image: php:8.2

stages:
  - test
  - deploy

test:
  stage: test
  script:
    # Vérifier la version de PHP et les extensions indispensables
    - php --version
    - php -m | grep -E "(dom|xml|zip|mbstring)" || (echo "❌ Extensions PHP manquantes !" && exit 1)
    - composer --version || (curl -sS https://getcomposer.org/installer | php && mv composer.phar /usr/local/bin/composer)
    - composer install --prefer-dist --no-interaction --no-scripts
    - cp .env.testing .env
    - php artisan key:generate --force
    - php artisan migrate --env=testing --force
    - mkdir -p storage/logs
    - php artisan test --log-junit storage/logs/junit.xml
  artifacts:
    when: always
    reports:
      junit: storage/logs/junit.xml
    paths:
      - storage/logs/
    expire_in: 1 week

deploy:
  stage: deploy
  script:
    - echo "🚀 Déploiement du back..."
    - rm -rf /home/flowadmin/back/*
    - cp -r . /home/flowadmin/back/
    - echo "🔃 Redémarrage de Nginx et PHP..."
    - docker compose -f /home/flowadmin/docker-compose.yml restart nginx
    - echo "✅ Déploiement terminé"
  only:
    - main
  dependencies:
    - test
  needs:
    - test
  tags:
    - back
