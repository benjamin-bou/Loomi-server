image: php:8.2

stages:
  - test
  - deploy

# üß™ Tests - S'ex√©cute sur toutes les branches
test:
  stage: test
  tags:
    - back
  before_script:
    # Diagnostiquer le syst√®me
    - echo "üîç Diagnostic du syst√®me..."
    - uname -a || echo "uname non disponible"
    - cat /etc/os-release || echo "os-release non disponible"
    - php -m | grep -E "(dom|xml|zip)" || echo "Extensions DOM/XML/ZIP non trouv√©es"
    
    # Installer les extensions PHP n√©cessaires si possible
    - sudo apt-get update -qq || echo "Pas de droits sudo, on continue..."
    - sudo apt-get install -y php8.2-dom php8.2-xml php8.2-zip php8.2-mbstring || echo "Installation des extensions √©chou√©e, on continue..."
    
    # Alternative avec les outils syst√®me
    - sudo apt-get install -y php-dom php-xml php-zip php-mbstring || echo "Installation alternative √©chou√©e, on continue..."
    
    # V√©rifier que PHP et Composer sont disponibles
    - php --version
    - composer --version || (echo "Composer non trouv√©, installation..." && curl -sS https://getcomposer.org/installer | php && sudo mv composer.phar /usr/local/bin/composer)
    
    # Installation des d√©pendances PHP (ignorer les extensions manquantes)
    - composer install --prefer-dist --no-interaction --no-dev --ignore-platform-reqs --no-scripts
    
    # G√©n√©rer l'autoload sans ex√©cuter les scripts Laravel
    - composer dump-autoload --optimize --no-dev --no-scripts
    
    # Configuration de l'environnement de test
    - cp .env.testing .env
    - php artisan key:generate --force || echo "Erreur lors de la g√©n√©ration de cl√©, mais on continue..."
    
  script:
    - echo "üß™ Lancement des tests..."
    # Cr√©er le dossier de logs si n√©cessaire
    - mkdir -p storage/logs
    - php artisan test
    - echo "‚úÖ Tests termin√©s"
    
  artifacts:
    when: always
    reports:
      junit: storage/logs/junit.xml
    paths:
      - storage/logs/
    expire_in: 1 week

# üöÄ D√©ploiement - Seulement sur main et apr√®s succ√®s des tests
deploy:
  stage: deploy
  tags:
    - back
  dependencies:
    - test
  script:
    - echo "üöö D√©ploiement du back..."
    - sudo rm -rf /home/flowadmin/back/*
    - sudo cp -r . /home/flowadmin/back/
    - echo "üîÉ Red√©marrage de Nginx et PHP..."
    - sudo docker compose -f /home/flowadmin/docker-compose.yml restart nginx
    - echo "‚úÖ D√©ploiement termin√©"
  only:
    - main
  needs:
    - test

